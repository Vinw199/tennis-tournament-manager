## Progress Log — 2025-08-18

### Summary
- Phase 1 (DB) complete earlier today. Since then we implemented Phase 2 basics and first data integration:
  - Supabase Auth wired (login, signup, signout), middleware-based token refresh, server layout guard.
  - Roster now reads/writes from Supabase (RLS-protected) scoped by `NEXT_PUBLIC_SPACE_ID`.
  - Space name fetched from DB and shown in the UI (sidebar, settings).
  - Dev seed function (`dev_seed`) to create a default space, admin membership, and ~20 players.

### Important Changes
- Auth & Session
  - Helpers under `utils/supabase/` using `@supabase/ssr`:
    - `client.js` → `createBrowserClient`
    - `server.js` → `createServerClient` with cookie sync via `getAll/setAll`
    - `middleware.js` → token refresh + cookie sync; allow unauthenticated access to `/login`, `/signup`, `/error`.
  - Server Actions in `app/(auth)/actions.js`: `login`, `signup`, `signout`.
  - Admin layout guard: `app/(with-sidebar)/layout.jsx` uses `auth.getUser()`; redirects to `/login` if no session.
- RLS Policies (Recursion Fix + Admin Writes)
  - Added SECURITY DEFINER helpers:
    - `get_user_spaces()` returns spaces for current user.
    - `get_user_admin_spaces()` returns admin spaces for current user.
  - Rewrote all table policies to use helpers, preventing self-referential recursion, and restored admin-only writes.
- Roster Integration
  - `app/(with-sidebar)/roster/page.js` now fetches and mutates `players` in Supabase (client-side for now), filtered by `NEXT_PUBLIC_SPACE_ID`.
- Space Name in UI
  - `app/(with-sidebar)/layout.jsx` fetches `spaces.name` and passes to `components/Sidebar.jsx`.
  - `app/(with-sidebar)/settings/page.js` shows the live space name.
- Seed for Local Dev
  - `supabase/seed.sql` defines `dev_seed(space_id?, space_name?)` to create a space, add caller as admin, and insert 20 players.

### Challenges & Resolutions
- Infinite recursion in RLS on `space_members`
  - Cause: policies referenced `space_members` within its own policy.
  - Fix: SECURITY DEFINER helpers + non-recursive membership checks; role-based write policies.
- CLI prompts/cancellation when pushing migrations
  - Cause: linked remote project → prompts and context-canceled on Windows.
  - Fixes: `--db-url` for local, unlink; when flaky, apply SQL via Studio or `docker exec psql`.
- Email confirmation + missing `auth.uid()` in SQL editor
  - Cause: Editor lacks authenticated context; `auth.uid()` null → `created_by` null.
  - Fix: Temporarily disable confirmations; or impersonate in SQL editor via `set_config('request.jwt.claim.*', ...)`; or call via app after login.
- Next.js 15 `searchParams` promise
  - Fix: Await `searchParams` in login/signup pages.
- SDK usage per docs
  - Aligned to `@supabase/ssr` placement in `utils/supabase/`; middleware added; removed old `lib/supabase/*`.

### How to Run Locally (Auth + Roster)
1) Ensure envs in `.env.local`:
   - `NEXT_PUBLIC_SUPABASE_URL=http://127.0.0.1:54321`
   - `NEXT_PUBLIC_SUPABASE_ANON_KEY=<from supabase status>`
   - `NEXT_PUBLIC_SPACE_ID=<from dev_seed()>`
2) Start: `npm run dev`
3) Sign up → login → roster shows seeded players; CRUD works for admin members.

### Next Up
- Membership on signup (auto-add user to `space_members` for `NEXT_PUBLIC_SPACE_ID`).
- Move roster read to Server Component and use server actions for writes (smaller client bundle).
- Tournament CRUD in Supabase; then entries/matches; then RPC for atomic launch.
- Optional: avatars storage bucket; realtime on matches.


